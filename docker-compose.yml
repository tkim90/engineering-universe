services:
  redis:
    image: redis/redis-stack-server:7.4.0-v2
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: ["redis-server", "--save", "60", "1", "--appendonly", "no"]

  crawler:
    build: .
    command: ["python", "main.py", "crawl"]
    environment:
      REDIS_URL: redis://redis:6379/0
      CRAWLER_CONCURRENCY: "200"
      SEED_START_URLS: "https://engineering.fb.com/,https://builders.ramp.com/,https://www.anthropic.com/engineering,https://developers.openai.com/blog/"
    depends_on:
      - redis
    profiles: ["crawler"]

  indexer:
    build: .
    command: ["python", "main.py", "index"]
    environment:
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - redis
    profiles: ["indexer"]

  api:
    build: .
    command: ["uvicorn", "api.search:app", "--host", "0.0.0.0", "--port", "8080"]
    ports:
      - "8080:8080"
    environment:
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - redis
    profiles: ["api"]

  metrics:
    build: .
    command: ["python", "main.py", "metrics"]
    ports:
      - "9100:9100"
    environment:
      METRICS_PORT: "9100"
    profiles: ["metrics"]

  seed:
    build: .
    command: ["python", "main.py", "seed"]
    environment:
      REDIS_URL: redis://redis:6379/0
      SEED_START_URLS: "https://engineering.fb.com/,https://builders.ramp.com/,https://www.anthropic.com/engineering,https://developers.openai.com/blog/"
    depends_on:
      - redis
    profiles: ["seed"]

volumes:
  redis-data:
